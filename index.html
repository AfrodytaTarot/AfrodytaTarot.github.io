<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Afrody.ta Tarot - Lecturas precisas y guiadas</title>
    <link rel="stylesheet" href="https://use.typekit.net/csj0vlf.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* ... (todo el CSS anterior se mantiene igual) ... */
    </style>
</head>
<body>
    <!-- Header y Navegaci√≥n -->
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">Afrody.ta Tarot</div>
                <div class="tagline">Una lectura precisa, √≠ntima y guiada por conocimiento</div>
                <ul class="tabs">
                    <li class="tab">
                        <button class="tab-button active" data-tab="inicio">Inicio</button>
                    </li>
                    <li class="tab">
                        <button class="tab-button" data-tab="problemas">Problemas</button>
                    </li>
                    <li class="tab">
                        <button class="tab-button" data-tab="servicios">Servicios</button>
                    </li>
                    <li class="tab">
                        <button class="tab-button" data-tab="cita">Agendar</button>
                    </li>
                    <li class="tab">
                        <button class="tab-button" data-tab="comentarios">Comentarios</button>
                    </li>
                </ul>
            </div>
        </div>
    </header>

    <!-- Contenido de las pesta√±as -->
    <main class="container">
        <!-- ... (todo el contenido anterior se mantiene igual hasta la secci√≥n de cita) ... -->

        <!-- Pesta√±a Agendar Cita -->
        <section id="cita" class="tab-content">
            <h2 class="section-title">AGENDA TU CITA</h2>
            <p class="section-subtitle">Completa el formulario y nos pondremos en contacto contigo para confirmar tu sesi√≥n</p>
            
            <div class="appointment-form">
                <!-- Secci√≥n de servicios seleccionados -->
                <div class="selected-services" id="selectedServices">
                    <h3>üõí Servicios Seleccionados</h3>
                    <div class="empty-cart" id="emptyCart">
                        No hay servicios seleccionados. Agrega servicios desde la pesta√±a "Servicios".
                    </div>
                    <div id="servicesList"></div>
                    
                    <!-- Secci√≥n para descuentos -->
                    <div class="discounts-section" id="discountsSection">
                        <div class="discounts-title">üéâ Descuentos Aplicados</div>
                        <div id="discountsList"></div>
                        <div class="final-total">
                            Total Final: $<span id="finalTotalAmount">0</span>
                        </div>
                    </div>
                    
                    <div class="cart-total" id="cartTotal" style="display: none;">
                        Subtotal: $<span id="totalAmount">0</span>
                    </div>
                </div>
                
                <div class="location-note">
                    <strong>‚ú® Importante:</strong> Las consultas a domicilio solo est√°n disponibles en Ciudad Madero - Tampico, Tamaulipas. Servicio con costo adicional de $50 pesos.
                </div>
                
                <form id="appointmentForm">
                    <div class="form-group">
                        <label for="name">Nombre completo *</label>
                        <input type="text" id="name" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="phone">N√∫mero de celular *</label>
                        <input type="tel" id="phone" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="email">Correo electr√≥nico *</label>
                        <input type="email" id="email" class="form-control" required>
                    </div>
                    
                    <!-- Secci√≥n de cumplea√±os -->
                    <div class="birthday-section" id="birthdaySection">
                        <div class="warning-note">
                            <strong>üéÇ LECTURA DE CUMPLEA√ëOS GRATIS</strong><br>
                            V√°lida 3 d√≠as antes y despu√©s de tu cumplea√±os. Solo una vez al a√±o por persona.
                        </div>
                        
                        <div class="form-group">
                            <label for="birthday">Fecha de cumplea√±os *</label>
                            <input type="date" id="birthday" class="form-control">
                            <small style="color: var(--secondary-color);">Se solicitar√° identificaci√≥n oficial para validar</small>
                        </div>
                        
                        <div class="birthday-warning" id="birthdayWarning" style="display: none;">
                            ‚ö†Ô∏è Esta lectura solo est√° disponible 3 d√≠as antes o despu√©s de tu cumplea√±os. Por favor selecciona otra lectura o verifica tu fecha.
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Tipo de consulta *</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="domicilio" name="consultationType" value="domicilio">
                                <label for="domicilio">A domicilio (+$50 adicional)</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="online" name="consultationType" value="online" checked>
                                <label for="online">En l√≠nea (WhatsApp)</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Secci√≥n de domicilio -->
                    <div class="domicilio-section" id="domicilioSection">
                        <div class="warning-note">
                            <strong>üìç Zona de Servicio:</strong> Ciudad Madero y Tampico, Tamaulipas. Si tu ubicaci√≥n est√° fuera de estas zonas, selecciona "En l√≠nea".
                        </div>
                        
                        <!-- Mapa -->
                        <div class="form-group">
                            <label>Selecciona tu ubicaci√≥n en el mapa</label>
                            <div class="map-container">
                                <div class="map-overlay">
                                    üìç Haz clic en tu ubicaci√≥n
                                </div>
                                <div id="map"></div>
                            </div>
                            <small style="color: var(--secondary-color);">Haz clic en el mapa para marcar tu ubicaci√≥n exacta</small>
                        </div>
                        
                        <!-- Informaci√≥n de la ubicaci√≥n seleccionada -->
                        <div class="location-info" id="locationInfo" style="display: none;">
                            <p><strong>üéØ Ubicaci√≥n confirmada:</strong> <span id="selectedLocation"></span></p>
                            <p><strong>üìè Coordenadas:</strong> <span id="coordinates"></span></p>
                        </div>
                        
                        <!-- Direcci√≥n manual -->
                        <div class="manual-address-section">
                            <div class="form-group">
                                <label for="direccionCompleta">üè† Direcci√≥n completa *</label>
                                <textarea id="direccionCompleta" class="form-control" placeholder="Escribe tu direcci√≥n completa: calle, n√∫mero, colonia, entre calles, referencia..."></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="codigoPostal">üìÆ C√≥digo Postal *</label>
                                <input type="text" id="codigoPostal" class="form-control" placeholder="89400">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="comments">Comentarios adicionales</label>
                        <textarea id="comments" class="form-control" placeholder="Cu√©ntanos m√°s sobre tu situaci√≥n, preguntas espec√≠ficas o cualquier informaci√≥n que consideres relevante..."></textarea>
                    </div>
                    
                    <button type="submit" class="btn" style="width: 100%;" id="submitButton">Enviar solicitud de cita</button>
                    
                    <!-- Mensajes de confirmaci√≥n -->
                    <div class="confirmation-messages">
                        <div class="loading" id="loadingMessage">
                            Enviando tu solicitud...
                        </div>
                        
                        <div class="success-message" id="successMessage">
                            ¬°Gracias! Tu solicitud ha sido enviada correctamente. Nos pondremos en contacto contigo en un plazo de 24 horas.
                        </div>
                        
                        <div class="error-message" id="errorMessage">
                            Ha ocurrido un error al enviar tu solicitud. Por favor, intenta nuevamente o cont√°ctanos directamente.
                        </div>
                    </div>
                </form>
            </div>
        </section>

        <!-- ... (resto del contenido se mantiene igual) ... -->
    </main>

    <!-- Footer -->
    <footer>
        <!-- ... (footer se mantiene igual) ... -->
    </footer>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Datos de servicios (se mantiene igual)
        const servicesData = {
            basicas: [
                { id: 'general', name: 'Lectura General', price: 135, description: 'Una visi√≥n completa de tu situaci√≥n actual y energ√≠as que te rodean.' },
                { id: 'general_3p', name: 'General + 3 Preguntas', price: 180, description: 'Lectura general m√°s respuestas espec√≠ficas a 3 preguntas de tu inter√©s.' },
                { id: '1p', name: '1 Pregunta Espec√≠fica', price: 50, description: 'Respuesta clara y directa a una pregunta concreta que tengas.' },
                { id: '2p', name: '2 Preguntas', price: 65, description: 'Respuestas detalladas a dos preguntas importantes para ti.' },
                { id: '3p', name: '3 Preguntas', price: 90, description: 'An√°lisis completo de tres √°reas espec√≠ficas de tu inter√©s.' },
                { id: 'semanal', name: 'Lectura Semanal', price: 185, description: 'Pron√≥stico energ√©tico para los pr√≥ximos 7 d√≠as.' },
                { id: 'mes', name: 'Lectura del Mes', price: 230, description: 'Visi√≥n completa de las energ√≠as del mes entrante.' },
                { id: 'dia', name: 'Lectura del D√≠a', price: 120, description: 'Gu√≠a energ√©tica para tomar las mejores decisiones hoy.' },
                { id: 'anio', name: 'Lectura del A√±o', price: 450, description: 'Pron√≥stico anual completo con tendencias y oportunidades.' },
                { id: 'amorosa', name: 'Lectura General Amorosa', price: 150, description: 'Enfoque especial en relaciones sentimentales y conexiones.' }
            ],
            especiales: [
                { id: 'escudo', name: 'Escudo de Compras', price: 100, description: 'Protecci√≥n energ√©tica para tus compras e inversiones.' },
                { id: 'hora_espejo', name: 'Hora Espejo', price: 111, description: 'Interpretaci√≥n de mensajes divinos a trav√©s de horas espejo.' },
                { id: 'mercurio', name: 'Mercurio Retr√≥grado', price: 190, description: 'Gu√≠a para navegar per√≠odos de Mercurio retr√≥grado.' },
                { id: 'casi_algo', name: 'Casi Algo', price: 155, description: 'An√°lisis de situaciones de "casi relaciones" o conexiones ambiguas.' },
                { id: 'pareja', name: 'Lectura de Pareja', price: 250, description: 'An√°lisis completo de la din√°mica de pareja y compatibilidad.' },
                { id: 'crush', name: 'Crush', price: 270, description: 'Insight sobre esa persona especial y posibilidades de conexi√≥n.' },
                { id: 'ex', name: 'Ex', price: 290, description: 'An√°lisis de relaciones pasadas y cierres k√°rmicos.' },
                { id: 'esposos', name: '¬øC√≥mo seremos como Esposos?', price: 380, description: 'Visi√≥n del potencial de vida en pareja a largo plazo.' },
                { id: 'corazon', name: 'Lectura del Coraz√≥n', price: 200, description: 'An√°lisis profundo de tus emociones y bloqueos sentimentales.' },
                { id: 'amantes', name: 'Amantes', price: 300, description: 'Insight sobre relaciones pasionales y conexiones intensas.' },
                { id: 'compatibilidad', name: 'Compatibilidad', price: 222, description: 'An√°lisis detallado de compatibilidad energ√©tica y emocional.' },
                { id: 'que_siente', name: '¬øQu√© siente por m√≠?', price: 240, description: 'Descubre los sentimientos y pensamientos de esa persona especial.' },
                { id: 'hack_pareja', name: 'Hack Pareja', price: 280, description: 'Estrategias energ√©ticas para mejorar tu relaci√≥n de pareja.' },
                { id: 'tinder', name: 'Tinder', price: 400, description: 'Gu√≠a para citas en l√≠nea y conexiones digitales aut√©nticas.' },
                { id: 'cupido', name: 'Consejo de Cupido', price: 400, description: 'Orientaci√≥n divina para el amor y las relaciones.' },
                { id: 'sexo', name: 'Sexo', price: 269, description: 'An√°lisis de compatibilidad sexual y conexi√≥n √≠ntima.' },
                { id: 'lo_que_ve', name: 'Lo que ve y piensa de m√≠', price: 340, description: 'Insight sobre la percepci√≥n que otros tienen de ti.' },
                { id: 'evolucion', name: 'Evoluci√≥n en Pareja', price: 340, description: 'Proyecci√≥n del crecimiento y desarrollo de la relaci√≥n.' },
                { id: 'cumpleanos', name: 'Lectura de Cumplea√±os', price: 0, description: 'Lectura especial de cumplea√±os gratis (v√°lida 3 d√≠as antes/despu√©s)' }
            ]
        };

        // Carrito de servicios
        let selectedServices = JSON.parse(localStorage.getItem('afrodyta_cart')) || [];

        // Mapa
        let map;
        let marker;
        let selectedLocation = null;

        function initMap() {
            if (map) return;
            
            const madero = [22.2699999, -97.8363];
            
            map = L.map('map').setView(madero, 14);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'OpenStreetMap',
                maxZoom: 18
            }).addTo(map);
            
            const pinkIcon = L.divIcon({
                className: 'custom-marker',
                html: 'üìç',
                iconSize: [30, 30],
                iconAnchor: [15, 30]
            });
            
            marker = L.marker(madero, {
                draggable: true,
                icon: pinkIcon
            }).addTo(map);
            
            marker.bindPopup("<div style='text-align: center;'><strong>Tu ubicaci√≥n</strong><br>Arrastra el marcador</div>").openPopup();
            
            marker.on('dragend', function(event) {
                const marker = event.target;
                const position = marker.getLatLng();
                updateLocation(position);
            });
            
            map.on('click', function(event) {
                const position = event.latlng;
                marker.setLatLng(position);
                updateLocation(position);
            });
        }

        function updateLocation(position) {
            selectedLocation = {
                lat: position.lat,
                lng: position.lng
            };
            
            document.getElementById('selectedLocation').textContent = `Lat: ${position.lat.toFixed(6)}, Lng: ${position.lng.toFixed(6)}`;
            document.getElementById('coordinates').textContent = `${position.lat.toFixed(6)}, ${position.lng.toFixed(6)}`;
            document.getElementById('locationInfo').style.display = 'block';
        }

        // Sistema de carrito (se mantiene igual)
        function addToCart(service) {
            const existingService = selectedServices.find(item => item.id === service.id);
            
            if (existingService) {
                existingService.quantity += 1;
            } else {
                selectedServices.push({
                    ...service,
                    quantity: 1
                });
            }
            
            saveCart();
            updateCartDisplay();
            updateServicesDisplay();
            
            showNotification(`‚úÖ ${service.name} agregado al carrito`);
        }

        function removeFromCart(serviceId) {
            selectedServices = selectedServices.filter(item => item.id !== serviceId);
            saveCart();
            updateCartDisplay();
            updateServicesDisplay();
        }

        function updateQuantity(serviceId, change) {
            const service = selectedServices.find(item => item.id === serviceId);
            if (service) {
                service.quantity += change;
                if (service.quantity <= 0) {
                    removeFromCart(serviceId);
                } else {
                    saveCart();
                    updateCartDisplay();
                    updateServicesDisplay();
                }
            }
        }

        function saveCart() {
            localStorage.setItem('afrodyta_cart', JSON.stringify(selectedServices));
        }

        // FUNCI√ìN MODIFICADA: Aplicar promociones y mostrar descuentos
        function applyPromotions(total) {
            let finalTotal = total;
            let discounts = [];
            
            // Promoci√≥n 3x2
            const expensiveServices = selectedServices
                .filter(service => service.price >= 250)
                .sort((a, b) => b.price - a.price);
            
            if (expensiveServices.length >= 3) {
                const freeService = expensiveServices[0];
                const discount = Math.min(freeService.price * freeService.quantity, 180);
                finalTotal -= discount;
                discounts.push({
                    description: `üéÅ Promoci√≥n 3x2: ${freeService.name} gratis`,
                    amount: discount
                });
            }
            
            // Promoci√≥n Lectura Gratis en compras > $500
            if (total > 500 && discounts.length === 0) {
                const freeReading = Math.min(180, total * 0.2);
                finalTotal -= freeReading;
                discounts.push({
                    description: 'üéÅ Lectura gratis en compras mayores a $500',
                    amount: freeReading
                });
            }
            
            // Mostrar descuentos en la interfaz
            displayDiscounts(discounts, finalTotal);
            
            return finalTotal;
        }

        // NUEVA FUNCI√ìN: Mostrar descuentos aplicados
        function displayDiscounts(discounts, finalTotal) {
            const discountsSection = document.getElementById('discountsSection');
            const discountsList = document.getElementById('discountsList');
            const finalTotalAmount = document.getElementById('finalTotalAmount');
            
            if (discounts.length > 0) {
                discountsSection.classList.add('active');
                discountsList.innerHTML = discounts.map(discount => `
                    <div class="discount-item">
                        <span class="discount-description">${discount.description}</span>
                        <span class="discount-amount">-$${discount.amount}</span>
                    </div>
                `).join('');
                finalTotalAmount.textContent = finalTotal;
            } else {
                discountsSection.classList.remove('active');
            }
        }

        // FUNCI√ìN MODIFICADA: Actualizar carrito para incluir descuentos
        function updateCartDisplay() {
            const servicesList = document.getElementById('servicesList');
            const emptyCart = document.getElementById('emptyCart');
            const cartTotal = document.getElementById('cartTotal');
            const totalAmount = document.getElementById('totalAmount');
            
            if (selectedServices.length === 0) {
                emptyCart.style.display = 'block';
                servicesList.innerHTML = '';
                cartTotal.style.display = 'none';
                document.getElementById('discountsSection').classList.remove('active');
                return;
            }
            
            emptyCart.style.display = 'none';
            
            let subtotal = 0;
            let hasBirthdayReading = false;
            
            servicesList.innerHTML = selectedServices.map(service => {
                const serviceTotal = service.price * service.quantity;
                subtotal += serviceTotal;
                
                if (service.id === 'cumpleanos') {
                    hasBirthdayReading = true;
                }
                
                return `
                    <div class="selected-service-item">
                        <div class="service-item-info">
                            <div class="service-item-name">${service.name}</div>
                            <div class="service-item-price">$${service.price} x ${service.quantity} = $${serviceTotal}</div>
                        </div>
                        <div class="service-item-actions">
                            <div class="quantity-controls active">
                                <button class="quantity-btn" onclick="updateQuantity('${service.id}', -1)">-</button>
                                <span class="quantity-display">${service.quantity}</span>
                                <button class="quantity-btn" onclick="updateQuantity('${service.id}', 1)">+</button>
                            </div>
                            <button class="remove-service-btn" onclick="removeFromCart('${service.id}')">√ó</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            totalAmount.textContent = subtotal;
            cartTotal.style.display = 'block';
            
            // APLICAR PROMOCIONES (esto actualizar√° los descuentos autom√°ticamente)
            const finalTotal = applyPromotions(subtotal);
            
            const birthdaySection = document.getElementById('birthdaySection');
            if (hasBirthdayReading) {
                birthdaySection.classList.add('active');
            } else {
                birthdaySection.classList.remove('active');
            }
        }

        function updateServicesDisplay() {
            for (const category in servicesData) {
                const container = document.querySelector(`#${category} .services-grid`);
                if (container) {
                    container.innerHTML = servicesData[category].map(service => {
                        const quantity = getServiceQuantity(service.id);
                        const hasQuantity = quantity > 0;
                        
                        return `
                            <div class="service-card" style="position: relative;">
                                ${hasQuantity ? `<div class="service-quantity-indicator">${quantity}</div>` : ''}
                                <h3>${service.name}</h3>
                                <div class="service-price">${service.price === 0 ? 'GRATIS' : `$${service.price}`}</div>
                                <div class="service-description">
                                    ${service.description}
                                </div>
                                <div class="service-actions">
                                    <div class="quantity-controls ${hasQuantity ? 'active' : ''}">
                                        <button class="quantity-btn" onclick="updateQuantity('${service.id}', -1)">-</button>
                                        <span class="quantity-display">${quantity}</span>
                                        <button class="quantity-btn" onclick="updateQuantity('${service.id}', 1)">+</button>
                                    </div>
                                    <button class="add-to-cart-btn" onclick="addToCart(${JSON.stringify(service).replace(/"/g, '&quot;')})">
                                        ${hasQuantity ? 'Actualizar' : 'Agregar'}
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            }
        }

        function getServiceQuantity(serviceId) {
            const service = selectedServices.find(item => item.id === serviceId);
            return service ? service.quantity : 0;
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--primary-color);
                color: var(--dark-bg);
                padding: 1rem 1.5rem;
                border-radius: 10px;
                font-family: "new-astro", sans-serif;
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
                box-shadow: 0 4px 15px rgba(255, 142, 199, 0.3);
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Sistema de comentarios
        let comments = JSON.parse(localStorage.getItem('afrodyta_comments')) || [];

        function saveComment(comment) {
            if (!comment.isAnonymous && comment.author !== 'An√≥nimo') {
                comment.author = comment.author.split(' ')[0];
            }
            
            comments.unshift(comment);
            localStorage.setItem('afrodyta_comments', JSON.stringify(comments));
            displayComments();
        }

        function displayComments() {
            const commentsList = document.getElementById('commentsList');
            
            if (comments.length === 0) {
                commentsList.innerHTML = '<div class="empty-comments">üåü S√© el primero en dejar un comentario</div>';
                return;
            }

            commentsList.innerHTML = comments.map(comment => `
                <div class="comment-card">
                    <div class="comment-header">
                        <div>
                            <span class="comment-author">${comment.author}</span>
                            ${comment.isAnonymous ? '<span class="anonymous-badge">An√≥nimo</span>' : ''}
                        </div>
                        <div class="comment-date">${comment.date}</div>
                    </div>
                    <div class="comment-text">${comment.text}</div>
                </div>
            `).join('');
        }

        // Validaci√≥n de cumplea√±os
        function isValidBirthdayForPromotion(birthday) {
            if (!birthday) return false;
            
            const today = new Date();
            const birthDate = new Date(birthday);
            
            const currentYear = today.getFullYear();
            birthDate.setFullYear(currentYear);
            
            const diffTime = Math.abs(today - birthDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            return diffDays <= 3;
        }

        // CORRECCI√ìN DEFINITIVA: Funcionalidad principal
        document.addEventListener('DOMContentLoaded', function() {
            // Generar servicios
            updateServicesDisplay();
            
            // Mostrar comentarios existentes
            displayComments();
            
            // Actualizar carrito
            updateCartDisplay();
            
            // Sistema de pesta√±as
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            function switchTab(tabId) {
                tabButtons.forEach(button => button.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                
                document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.add('active');
                document.getElementById(tabId).classList.add('active');
                
                if (window.innerWidth <= 768) {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
                
                // Inicializar mapa cuando la pesta√±a de cita est√© activa
                if (tabId === 'cita') {
                    setTimeout(() => {
                        if (!map) {
                            initMap();
                        } else {
                            map.invalidateSize();
                        }
                    }, 100);
                }
            }
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });

            // Sistema de men√∫ horizontal de servicios
            const serviceMenuBtns = document.querySelectorAll('.service-menu-btn');
            const serviceCategories = document.querySelectorAll('.services-category');
            
            serviceMenuBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const categoryId = this.getAttribute('data-category');
                    
                    serviceMenuBtns.forEach(b => b.classList.remove('active'));
                    serviceCategories.forEach(cat => cat.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(categoryId).classList.add('active');
                });
            });

            // Botones que redirigen a agendar cita
            document.querySelectorAll('.btn[data-tab="cita"]').forEach(element => {
                element.addEventListener('click', function() {
                    switchTab('cita');
                });
            });

            // Mostrar/ocultar secci√≥n de domicilio
            const domicilioRadio = document.getElementById('domicilio');
            const onlineRadio = document.getElementById('online');
            const domicilioSection = document.getElementById('domicilioSection');
            
            domicilioRadio.addEventListener('change', function() {
                if (this.checked) {
                    domicilioSection.classList.add('active');
                    setTimeout(() => {
                        if (!map) {
                            initMap();
                        } else {
                            map.invalidateSize();
                        }
                    }, 300);
                }
            });
            
            onlineRadio.addEventListener('change', function() {
                if (this.checked) {
                    domicilioSection.classList.remove('active');
                }
            });

            // Validaci√≥n de fecha de cumplea√±os
            const birthdayInput = document.getElementById('birthday');
            const birthdayWarning = document.getElementById('birthdayWarning');
            
            birthdayInput.addEventListener('change', function() {
                if (!isValidBirthdayForPromotion(this.value)) {
                    birthdayWarning.style.display = 'block';
                } else {
                    birthdayWarning.style.display = 'none';
                }
            });

            // Manejo del formulario de comentarios
            document.getElementById('commentForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const name = document.getElementById('commentName').value.trim();
                const phone = document.getElementById('commentPhone').value.trim();
                const text = document.getElementById('commentText').value.trim();
                const isAnonymous = document.getElementById('isAnonymous').checked;
                
                if (!name || !phone || !text) {
                    alert('Por favor completa todos los campos obligatorios');
                    return;
                }

                const firstName = name.split(' ')[0];

                const comment = {
                    author: isAnonymous ? 'An√≥nimo' : firstName,
                    text: text,
                    isAnonymous: isAnonymous,
                    date: new Date().toLocaleDateString('es-MX', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    })
                };

                saveComment(comment);
                
                this.reset();
                document.getElementById('isAnonymous').checked = false;
                
                showNotification('¬°Gracias por tu comentario! üåü');
            });

            // CORRECCI√ìN DEFINITIVA: Manejo del formulario de citas
            document.getElementById('appointmentForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                console.log('Formulario enviado - Iniciando validaci√≥n...');
                
                // Validaci√≥n b√°sica
                if (selectedServices.length === 0) {
                    alert('Por favor agrega al menos un servicio antes de enviar la solicitud.');
                    return;
                }
                
                const name = document.getElementById('name').value.trim();
                const phone = document.getElementById('phone').value.trim();
                const email = document.getElementById('email').value.trim();
                const consultationType = document.querySelector('input[name="consultationType"]:checked');
                
                if (!name || !phone || !email) {
                    alert('Por favor completa todos los campos obligatorios.');
                    return;
                }
                
                if (!consultationType) {
                    alert('Por favor selecciona un tipo de consulta.');
                    return;
                }
                
                const consultationTypeValue = consultationType.value;
                const comments = document.getElementById('comments').value.trim();
                
                console.log('Tipo de consulta seleccionado:', consultationTypeValue);
                
                // Validar lectura de cumplea√±os
                const hasBirthdayReading = selectedServices.some(service => service.id === 'cumpleanos');
                if (hasBirthdayReading) {
                    const birthday = document.getElementById('birthday').value;
                    if (!isValidBirthdayForPromotion(birthday)) {
                        alert('La lectura de cumplea√±os solo est√° disponible 3 d√≠as antes o despu√©s de tu cumplea√±os. Por favor verifica tu fecha.');
                        return;
                    }
                }
                
                // CORRECCI√ìN: Remover required de campos ocultos
                const direccionInput = document.getElementById('direccionCompleta');
                const codigoPostalInput = document.getElementById('codigoPostal');
                
                if (consultationTypeValue === 'online') {
                    // Para consultas en l√≠nea, remover required de campos de domicilio
                    direccionInput.removeAttribute('required');
                    codigoPostalInput.removeAttribute('required');
                } else {
                    // Para domicilio, agregar required
                    direccionInput.setAttribute('required', 'required');
                    codigoPostalInput.setAttribute('required', 'required');
                }
                
                // Preparar informaci√≥n del paquete
                let packageInfo = 'SERVICIOS SELECCIONADOS:\n';
                const subtotal = selectedServices.reduce((sum, service) => sum + (service.price * service.quantity), 0);
                const finalTotal = applyPromotions(subtotal);
                
                selectedServices.forEach(service => {
                    packageInfo += `‚Ä¢ ${service.name} x${service.quantity} - $${service.price * service.quantity}\n`;
                });
                
                packageInfo += `\nSUBTOTAL: $${subtotal}`;
                
                // Agregar informaci√≥n de descuentos
                const discountsSection = document.getElementById('discountsSection');
                if (discountsSection.classList.contains('active')) {
                    const discountItems = document.querySelectorAll('.discount-item');
                    discountItems.forEach(item => {
                        const desc = item.querySelector('.discount-description').textContent;
                        const amount = item.querySelector('.discount-amount').textContent;
                        packageInfo += `\n${desc}: ${amount}`;
                    });
                    packageInfo += `\nTOTAL FINAL: $${finalTotal}`;
                } else {
                    packageInfo += `\nTOTAL: $${finalTotal}`;
                }
                
                // Preparar informaci√≥n de ubicaci√≥n
                let direccion = 'Consulta en l√≠nea (WhatsApp)';
                let coordenadas = 'No aplica';
                let totalConDomicilio = finalTotal;
                
                if (consultationTypeValue === 'domicilio') {
                    const direccionValue = direccionInput.value.trim();
                    const codigoPostalValue = codigoPostalInput.value.trim();
                    
                    if (!direccionValue || !codigoPostalValue) {
                        alert('Para servicio a domicilio, por favor completa la direcci√≥n y c√≥digo postal.');
                        return;
                    }
                    
                    if (!selectedLocation) {
                        alert('Por favor selecciona una ubicaci√≥n en el mapa.');
                        return;
                    }
                    
                    direccion = `${direccionValue} | C.P. ${codigoPostalValue}`;
                    coordenadas = `${selectedLocation.lat.toFixed(6)}, ${selectedLocation.lng.toFixed(6)}`;
                    totalConDomicilio = finalTotal + 50;
                    
                    packageInfo += `\n\nüí´ SERVICIO A DOMICILIO: +$50`;
                    packageInfo += `\nTOTAL CON DOMICILIO: $${totalConDomicilio}`;
                }
                
                console.log('Preparando env√≠o de email...');
                
                // Mostrar loading
                document.getElementById('loadingMessage').style.display = 'block';
                document.getElementById('successMessage').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'none';
                document.getElementById('submitButton').disabled = true;
                
                // Preparar par√°metros para EmailJS
                const templateParams = {
                    from_name: name,
                    from_phone: phone,
                    from_email: email,
                    package: packageInfo,
                    consultation_type: consultationTypeValue === 'domicilio' ? 'A domicilio (+$50 adicional)' : 'En l√≠nea (WhatsApp)',
                    direccion: direccion,
                    coordenadas: coordenadas,
                    comments: comments || 'No proporcion√≥ comentarios adicionales',
                    date: new Date().toLocaleString('es-MX'),
                    total: consultationTypeValue === 'domicilio' ? totalConDomicilio : finalTotal
                };
                
                console.log('Enviando correo con par√°metros:', templateParams);
                
                // Env√≠o del correo
                emailjs.send('service_z35hg3c', 'template_p8np16h', templateParams)
                    .then(function(response) {
                        console.log('SUCCESS!', response.status, response.text);
                        document.getElementById('loadingMessage').style.display = 'none';
                        document.getElementById('successMessage').style.display = 'block';
                        document.getElementById('submitButton').disabled = false;
                        
                        // Limpiar formulario despu√©s del √©xito
                        setTimeout(() => {
                            document.getElementById('appointmentForm').reset();
                            document.getElementById('successMessage').style.display = 'none';
                            document.getElementById('domicilioSection').classList.remove('active');
                            document.getElementById('birthdaySection').classList.remove('active');
                            document.getElementById('locationInfo').style.display = 'none';
                            selectedLocation = null;
                            
                            // Limpiar carrito
                            selectedServices = [];
                            saveCart();
                            updateCartDisplay();
                            updateServicesDisplay();
                            
                            console.log('Formulario limpiado exitosamente');
                        }, 5000);
                        
                    }, function(error) {
                        console.error('FAILED...', error);
                        document.getElementById('loadingMessage').style.display = 'none';
                        document.getElementById('errorMessage').style.display = 'block';
                        document.getElementById('submitButton').disabled = false;
                        
                        // Mostrar detalles del error
                        let errorDetails = 'Error desconocido';
                        if (error.text) {
                            errorDetails = error.text;
                        } else if (error.message) {
                            errorDetails = error.message;
                        }
                        console.error('Detalles del error:', errorDetails);
                    });
            });
        });

        // Estilos CSS para las notificaciones
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
    
    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="text/javascript">
        emailjs.init("D9IIhpZUFtIUOA0Rr");
    </script>
</body>
</html>
